C51 COMPILER V9.01   DS18B20                                                               03/30/2023 21:11:44 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Objects\DS18b20.obj
COMPILER INVOKED BY: C:\keil5\C51\BIN\C51.EXE src\DS18b20.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\src) DEBUG OBJECTEXTEND PR
                    -INT(.\Listings\DS18b20.lst) TABS(2) OBJECT(.\Objects\DS18b20.obj)

line level    source

   1          /**************************************************************************************************
   2          //程序名称 ：DS18B20
   3          //应用芯片 ：STC1T单片机
   4          //设计单位 ：
   5          //设计作者 ：Yanggang
   6          //创建日期 ：2011年8月8日
   7          //修改作者 ： 
   8          //修改日期 ： 
   9          //版本 ： V1.0
  10          //版权 ：
  11          //------------------------------------------------------------------------------------------------
  12          //程序功能描述 ： 
  13          //--------------
  14          //--------------
  15          //--------------
  16          //------------------------------------------------------------------------------------------------
  17          **************************************************************************************************/
  18          
  19          /**************************************************************************************************
  20          ** 编译预处理 ：文件包含；宏定义；变量声明；函数声明
  21          ** 应用描述 ：
  22          ** 其他说明 ：无
  23          **************************************************************************************************/
  24          
  25          /*---------------包含头文件--------------------*/
  26          #include "DS18b20.h"
  27          
  28          void delay1us(unsigned char time) 
  29          {
  30   1         while (time--)
  31   1          {
  32   2              _nop_();
  33   2              _nop_();
  34   2          }
  35   1      }
  36          /******************************************************************
  37           - 功能描述：DS18B20复位(初始化)
  38           - 隶属模块：DS18B20模块
  39           - 函数属性：内部
  40           - 参数说明：无      
  41           - 返回说明：返回值为0说明复位成功，否则失败
  42           - 注：初始化是正确操作DS18B20是重要一步，必须复位成功
  43           ******************************************************************/
  44          
  45          unsigned char DS18B20_Reset()
  46          {
  47   1        unsigned char x=0;
  48   1        DS18B20_DQ=1;          //DQ拉高
  49   1        DS18B20_DQ=0;          //单片机将DQ拉低
  50   1        delay1us(240);   //延时 480us~960us
  51   1        delay1us(240);
  52   1        DS18B20_DQ=1;          //DQ拉高
  53   1                    //以上是由单片机产生“复位脉冲”
  54   1        delay1us(60);    //延时15us~60us
C51 COMPILER V9.01   DS18B20                                                               03/30/2023 21:11:44 PAGE 2   

  55   1        x=DS18B20_DQ;          //DS18B20产生“存在脉冲”
  56   1                    //检测DQ 如果为低，说明复位成功，DS18B20存在
  57   1                    //如果为高，说明复位失败，DS18B20损坏或不存在
  58   1        while(!DS18B20_DQ);    //直到DQ为高
  59   1        DS18B20_DQ = 1;
  60   1        return x;     //返回复位结果
  61   1      }
  62          
  63          /******************************************************************
  64           - 功能描述：从DS18B20读取一个位(DS18B20的读时间片)
  65           - 隶属模块：DS18B20模块
  66           - 函数属性：内部
  67           - 参数说明：无   
  68           - 返回说明：读到的值，1或0
  69           - 注：DS18B20的读时间片对时间的要求较为严格。因此将此代码移植到其它
  70                 CPU或场合时要注意延时函数
  71           ******************************************************************/
  72          
  73          unsigned char DS18B20_ReadSlot()
  74          {
  75   1        unsigned char bdat=0;
  76   1              
  77   1        DS18B20_DQ=0;         //开始一个读时间片
  78   1        _nop_();      //写时间片的低电平保持1us以上
  79   1        DS18B20_DQ=1;         //开始读取数据线状态
  80   1        _nop_();      //写时间片的低电平保持1us以上
  81   1      
  82   1        bdat=DS18B20_DQ;    //读取位数据
  83   1        delay1us(60);     //(注：时间不能修改)读时间片最短60us
  84   1        DS18B20_DQ=1;
  85   1      
  86   1        return bdat;  
  87   1      }
  88          
  89          /******************************************************************
  90           - 功能描述：向DS18B20写入一个位(DS18B20的写时间片)
  91           - 隶属模块：DS18B20模块
  92           - 函数属性：内部
  93           - 参数说明：bdat:要写入的值，非0为1      
  94           - 返回说明：无
  95           - 注：DS18B20的写时间片对时间的要求较为严格。因此将此代码移植到其它
  96                 CPU或场合时要注意延时函数
  97           ******************************************************************/
  98          
  99          void DS18B20_WriteSlot(unsigned char bdat)
 100          {
 101   1        DS18B20_DQ=0;       //开始一个写时间片
 102   1        delay1us(1);    //写时间片的低电平保持1us以上
 103   1        DS18B20_DQ=bdat; 
 104   1        delay1us(20);   //写时间片开始15us后DS18B20对数据线进行采样，但写时间片最短60us
 105   1        DS18B20_DQ=1;  
 106   1      }
 107          
 108          /******************************************************************
 109           - 功能描述：从DS18B20读取一个字节
 110           - 隶属模块：DS18B20模块
 111           - 函数属性：内部
 112           - 参数说明：无      
 113           - 返回说明：从DS18B20读到的字节
 114           - 注：此函数调用读时间片来实现字节的读取
 115           *****************************************************************/
 116          
C51 COMPILER V9.01   DS18B20                                                               03/30/2023 21:11:44 PAGE 3   

 117          unsigned char DS18B20_ReadByte()
 118          {
 119   1       
 120   1        unsigned char i=0,dat=0;
 121   1        
 122   1      //  Time0_Stop();   //由于DS18B20读取温度的时候对时间特别敏感所以再读时间的时候停止中断
 123   1        DS18B20_DQ=1;      //开始读取数据线状态
 124   1        for(i=0;i<8;i++)  //调用8次读时间片实现字节读取(8个位)
 125   1        {
 126   2          dat|=(DS18B20_ReadSlot()<<i);
 127   2        }
 128   1      //  Time0_Start();    //读完温度后开启中断
 129   1        return(dat);
 130   1      
 131   1      }
 132          
 133          /******************************************************************
 134           - 功能描述：向DS18B20写入一个字节
 135           - 隶属模块：DS18B20模块
 136           - 函数属性：内部
 137           - 参数说明：dat:将要向DS18B20写入字节      
 138           - 返回说明：无
 139           - 注：此函数调用写时间片来实现字节的写入
 140           ******************************************************************/
 141          
 142          void DS18B20_WriteByte(unsigned char dat)
 143          {
 144   1        unsigned char i=0;
 145   1        for(i=0;i<8;i++)   //调用8次写时间片实现写入字节(8个位)
 146   1        {
 147   2          DS18B20_WriteSlot(dat&(1<<i));
 148   2        }
 149   1      }
 150           
 151          /******************************************************************
 152           - 功能描述：设置DS18B20的精度
 153           - 隶属模块：DS18B20模块
 154           - 函数属性：外部，供用户使用
 155           - 参数说明：res:精度值  0:9位 1:10位 2:11位 3:12位    
 156           - 返回说明：无
 157           - 注：精度越低，可读的小数位数越少，比如在12位的精度下，可分辨温度
 158                 为0.0625，即可读小数位数为4位，而如果是10位的精度，则可分辨
 159               温度为0.25，可读小数位数只有2位。
 160           ******************************************************************/
 161          
 162          void DS18B20_SetResolution(unsigned char res)
 163          {
 164   1        while(DS18B20_Reset());  //复位，通信前必须复位
 165   1        DS18B20_WriteByte(Write_Scratchpad); //写暂存器指令
 166   1        DS18B20_WriteByte(0xff); //此值被写入TH
 167   1        DS18B20_WriteByte(0xff); //此值被写入TL
 168   1        DS18B20_WriteByte(0x1f|(res<<5)); //设置精度  0 res[1-0] 11111
 169   1      }
 170          
 171          /******************************************************************
 172           - 功能描述：从DS18B20中读取温度
 173           - 隶属模块：DS18B20模块
 174           - 函数属性：外部，供用户使用
 175           - 参数说明：无      
 176           - 返回说明：由于返回的温度是浮点数(即小数)，为了方便返回的值将为原
 177                       值的10000倍，即精确到小数点后2位，用户需要对返回值除以
 178                 10000得到实际的温度值
C51 COMPILER V9.01   DS18B20                                                               03/30/2023 21:11:44 PAGE 4   

 179           - 注：无
 180           ******************************************************************/
 181          
 182          long DS18B20_ReadTemperature()
 183          {
 184   1        long t=0;
 185   1        while(DS18B20_Reset());       //复位，通信前必须复位
 186   1        DS18B20_WriteByte(Skip_ROM);  //如果总线上只有一个DS18B20，则可跳过ROM操作
 187   1        DS18B20_WriteByte(Convert_T); //启动温度转换
 188   1        while(!DS18B20_ReadSlot());   //启动温度转换后要进行读忙，9~12位精度温度转换所需的
 189   1                                   //最长时间分别为93.75ms、187.5ms、375ms、750ms
 190   1                                   //如果不读忙而紧接着进行后面的操作，将在首次上电时可能导致85现象
 191   1                       //因为读到的不是温度值，而是初始值0x0550，即85
 192   1        while(DS18B20_Reset());       //温度转换后DS18B20处于空闲状态，要进行通信，需要重新复位
 193   1        DS18B20_WriteByte(Skip_ROM);  //跳过ROM操作
 194   1        DS18B20_WriteByte(Read_Scratchpad); //读取暂存器（共可读9个寄存器，前两个就是温度） 
 195   1        t=DS18B20_ReadByte();   
 196   1        t|=((unsigned int)DS18B20_ReadByte())<<8; //将读到的两个字节进行整合
 197   1        
 198   1        return t*625;                             //将结果乘以分辨温度0.0625
 199   1                                                 //扩大10000倍进行输出，不用浮点，同样可以保留4位小数精度        
             -                    
 200   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    272    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
